{"version":3,"sources":["../src/LocalForage.js"],"names":["localforage","canStoreInLN","localStorage","setItem","i","getItem","console","log","removeItem","e","localStorageValid","canStoreInLS","dbFactory","props","createInstance","name","driver","db","_buildSortFn","sort","field","order","sorter","set","fld","isAsc","a","b","av","bv","forEach","s","toUpperCase","inst","LocalForage","local","LocalFS","defineDriver","querySizeLimit","fn","bind","dbs","dropInstance","undefined","storeSchema","validateSync","_getDB","key","data","database","storeBulkSchema","setItems","items","readSchema","r","readAllSchema","sortFn","limit","filterFn","iterate","v","k","itNum","push","iterateSchema","callback","Error","findSchema","selKeys","_","keys","selector","offset","includeTotal","skipping","endLength","total","dbVal","dbKey","allMatch","length","p","tgt","isNaN","updateSchema","removeSchema","BaseDB"],"mappings":"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","file":"LocalForage.js","sourcesContent":["import localforage from 'localforage';\nimport {extendPrototype} from 'localforage-setitems';\nimport BaseDB, {\n  storeSchema,\n  storeBulkSchema,\n  readSchema,\n  readAllSchema,\n  findSchema,\n  updateSchema,\n  removeSchema,\n  iterateSchema\n} from './BaseDB';\nimport _ from 'lodash';\nimport LocalFS from \"./LocalFSStorage\";\n\nextendPrototype(localforage);\n\nconst canStoreInLN = () => {\n  try {\n\n    localStorage.setItem(\"__test\", \"true\");\n\n    let i = localStorage.getItem(\"__test\");\n    console.log(\"LS test\", i);\n    if(!i) {\n      return false;\n    }\n    localStorage.removeItem(\"__test\");\n    return true;\n  } catch (e) {\n    console.log(\"Problem storing LS\", e);\n    return false;\n  }\n}\n\nconst localStorageValid = () => {\n  console.log(\"Testing local storage\");\n  return (typeof localStorage !== 'undefined') &&\n            'setItem' in localStorage &&\n            canStoreInLS()\n}\n\nconst dbFactory = async props => {\n  var db = await localforage.createInstance({\n    name: props.name,\n    driver: \"localFSDriver\"\n  });\n  return db;\n}\n\nconst _buildSortFn = props => {\n  if(!props.sort) {\n    props.sort = [\n      {\n        field: \"blockNumber\",\n        order: \"desc\"\n      }\n    ];\n  }\n\n  let sorter = (set, fld, isAsc) => {\n    set.sort((a,b)=>{\n      let av = a[fld];\n      let bv = b[fld];\n      if(av > bv) {\n        return isAsc ? 1 : -1;\n      }\n      if(av < bv) {\n        return isAsc ? -1 : 1;\n      }\n      return 0;\n    });\n  };\n  return set => {\n    props.sort.forEach(s=>{\n      sorter(set, s.field, s.order.toUpperCase() === 'ASC')\n    });\n  }\n}\n\nlet inst = null;\nexport default class LocalForage extends BaseDB {\n  static get instance() {\n\n    if(!inst) {\n      if(!localStorageValid()) {\n        console.log(\"Installing local FS driver...\");\n        let local = new LocalFS();\n        localforage.defineDriver(local);\n      }\n      inst = new LocalForage();\n    }\n    return inst;\n  }\n\n  constructor(props) {\n    super(props);\n    this.querySizeLimit = props?props.querySizeLimit || 50:50;\n\n    [\n      'store',\n      'storeBulk',\n      'read',\n      'readAll',\n      'find',\n      'update',\n      'remove',\n      'removeDB',\n      'iterate'\n    ].forEach(fn=>{\n      this[fn]=this[fn].bind(this)\n    });\n  }\n\n  async removeDB(name) {\n    let db = this.dbs[name];\n    if(!db) {\n      return;\n    }\n    console.log(\"Dropping DB\", name);\n    db.dropInstance();\n    this.dbs[name] = undefined;\n  }\n\n  async store(props) {\n    storeSchema.validateSync(props);\n    let db = await this._getDB(props, dbFactory);\n    try {\n      await db.setItem(props.key, props.data);\n    } catch (e) {\n      console.log(\"Problem storing to\", props.database, e);\n    }\n\n  }\n\n  async storeBulk(props) {\n    storeBulkSchema.validateSync(props);\n    let db = await this._getDB(props, dbFactory);\n    try {\n      await db.setItems(props.items);\n    } catch (e) {\n      console.log(\"Problem storing items\", props.database, e);\n    }\n  }\n\n  async read(props) {\n    readSchema.validateSync(props);\n    let db = await this._getDB(props, dbFactory);\n    let r = await db.getItem(props.key);\n    return r ? [r] : [];\n  }\n\n  async readAll(props) {\n    readAllSchema.validateSync(props);\n    let db = await this._getDB(props, dbFactory);\n\n    let set = [];\n    let sortFn = _buildSortFn(props);\n    let limit = props.limit || this.querySizeLimit;\n    let filterFn = props.filterFn;\n    await db.iterate((v, k, itNum)=>{\n      if(itNum > limit) {\n        return set;\n      }\n      if(filterFn) {\n        if(filterFn(v, k, itNum)) {\n          set.push(v);\n        }\n      } else {\n        set.push(v);\n      }\n    });\n    if(sortFn) {\n      sortFn(set);\n    }\n    return set;\n  }\n\n  async iterate(props) {\n    iterateSchema.validateSync(props);\n    if(typeof props.callback !== 'function') {\n      throw new Error(\"Missing callback function\");\n    }\n    let db = await this._getDB(props, dbFactory);\n    await db.iterate(props.callback);\n  }\n\n  async find(props) {\n    findSchema.validateSync(props);\n    let db = await this._getDB(props, dbFactory);\n    let set = [];\n    let sortFn = _buildSortFn(props);\n    let limit = props.limit || this.querySizeLimit;\n    let selKeys = _.keys(props.selector);\n    let offset = props.offset || 0;\n    let includeTotal = props.includeTotal;\n    let skipping = offset > 0;\n    let endLength = offset + limit;\n\n    let total = 0;\n    await db.iterate((dbVal, dbKey, itNum)=>{\n      let allMatch = true;\n      //filter based on selectors first. This way we make\n      //sure paging and sorting work with the same dataset\n      //each time. This is terribly slow but localforage/indexedDB\n      //doesn't offer skipping records. An optimization might be\n      //to keep our own index of record counts so that at a minimum\n      //we're not running through entire set each time. Skipping would\n      //still require walk from beginning. I don't know what happens if\n      //records are inserted during paging operation...would we miss an\n      //item if it's key were iterated earlier than the page we skipped?\n      //This needs more thought.\n      for(let i=0;i<selKeys.length;++i) {\n        let p = selKeys[i];\n        let tgt = props.selector[p];\n        let v = dbVal[p];\n        if(!isNaN(v) && !isNaN(tgt)) {\n          v -= 0;\n          tgt -= 0;\n        }\n        if(v !== tgt) {\n          allMatch = false;\n          break;\n        }\n      }\n      if(allMatch) {\n        ++total;\n        if(!skipping && set.length < endLength) {\n          set.push(dbVal);\n        } else if(!skipping && set.length >= endLength && !includeTotal) {\n          return set;\n        }\n      }\n\n      skipping = total < offset || set.length > (offset+limit);\n    });\n\n    if(sortFn) {\n      sortFn(set);\n    }\n    if(includeTotal) {\n      return {\n        total,\n        data: set\n      }\n    }\n    return set;\n  }\n\n  async update(props) {\n    updateSchema.validateSync(props);\n  }\n\n  async remove(props) {\n    removeSchema.validateSync(props);\n  }\n}\n"]}