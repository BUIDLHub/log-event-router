{"version":3,"sources":["../src/EventNormalizer.js"],"names":["yup","schema","object","shape","web3","required","EventNormalizer","props","abi","fnSigs","Array","isArray","Error","forEach","a","type","signature","fn","bind","event","history","retVals","returnValues","_","keys","d","k","_ethersType","toString","txn","transactionHash","toLowerCase","start","Date","now","eth","getTransaction","console","log","hash","input","length","sig","substring","def","fnContext","name","logEvents","le","ex","push"],"mappings":";;;;;;;;;;AAAA;;IAAYA,G;;AACZ;;;;;;;;;;;;AAEA,IAAMC,SAASD,IAAIE,MAAJ,GAAaC,KAAb,CAAmB;AAChCC,QAAMJ,IAAIE,MAAJ,GAAaG,QAAb,CAAsB,2CAAtB;AAD0B,CAAnB,CAAf;;IAIqBC,e;AACnB,2BAAYC,KAAZ,EAAmB;AAAA;;AAAA;;AACjB,SAAKH,IAAL,GAAYG,MAAMH,IAAlB;AACA,QAAII,MAAMD,MAAMC,GAAhB;AACA,SAAKC,MAAL,GAAc,EAAd;;AAGA,QAAG,CAACC,MAAMC,OAAN,CAAcH,GAAd,CAAJ,EAAwB;AACtB,YAAM,IAAII,KAAJ,CAAU,mEAAV,CAAN;AACD;;AAEDJ,QAAIK,OAAJ,CAAY,aAAG;AACb,UAAGC,EAAEC,IAAF,KAAW,UAAd,EAA0B;AACxB,YAAGD,EAAEE,SAAL,EAAgB;AACd,gBAAKP,MAAL,CAAYK,EAAEE,SAAd,IAA2BF,CAA3B;AACD;AACF;AACF,KAND;;AAQA,KACE,WADF,EAEED,OAFF,CAEU;AAAA,aAAI,MAAKI,EAAL,IAAS,MAAKA,EAAL,EAASC,IAAT,CAAc,KAAd,CAAb;AAAA,KAFV;AAGD;;;;;0FAEeC,K,EAAOC,O;;;;;;AACjBC,uB,GAAUF,MAAMG,Y;AACpB;;AACAC,iCAAEC,IAAF,CAAOH,OAAP,EAAgBR,OAAhB,CAAwB,aAAG;AACzB,sBAAIY,IAAIJ,QAAQK,CAAR,CAAR;AACA,sBAAGD,EAAEE,WAAF,KAAkB,WAArB,EAAkC;AAChCN,4BAAQK,CAAR,IAAaD,EAAEG,QAAF,EAAb;AACD;AACF,iBALD;;AAOIC,mB,GAAMT,QAAQD,MAAMW,eAAN,CAAsBC,WAAtB,EAAR,C;;oBAENF,G;;;;;AACEG,qB,GAAQC,KAAKC,GAAL,E;;uBACA,KAAK9B,IAAL,CAAU+B,GAAV,CAAcC,cAAd,CAA6BjB,MAAMW,eAAnC,C;;;AAAZD,mB;;AACAQ,wBAAQC,GAAR,CAAY,mBAAZ,EAAkCL,KAAKC,GAAL,KAAWF,KAA7C,EAAoD,IAApD;AACA,oBAAGH,GAAH,EAAQ;AACNT,0BAAQS,IAAIU,IAAJ,CAASR,WAAT,EAAR,IAAkCF,GAAlC;;AAEA,sBAAGA,IAAIW,KAAJ,IAAaX,IAAIW,KAAJ,CAAUC,MAAV,GAAmB,CAAnC,EAAsC;;AAEpC;AACIC,uBAHgC,GAG1Bb,IAAIW,KAAJ,CAAUG,SAAV,CAAoB,CAApB,EAAuB,EAAvB,CAH0B;;AAKpC;;AACIC,uBANgC,GAM1B,KAAKnC,MAAL,CAAYiC,GAAZ,CAN0B;;AAOpC,wBAAGE,GAAH,EAAQ;AACN;AACA;AACA;AACAf,0BAAIgB,SAAJ,GAAgBD,IAAIE,IAApB;AACD;AACF,mBAbD,MAaO;AACLjB,wBAAIgB,SAAJ,GAAgB,UAAhB;AACD;AACDhB,sBAAIkB,SAAJ,GAAgB,EAAhB;AACD;;;AAEH,oBAAGlB,GAAH,EAAQ;AACFmB,oBADE,gBAEDnB,IAAIkB,SAFH;AAIFE,oBAJE,GAIGD,GAAG7B,MAAMA,KAAT,CAJH;;AAKN,sBAAG8B,EAAH,EAAO;AACDnC,qBADC,GACG,CAACmC,EAAD,CADH;;AAELnC,sBAAEoC,IAAF,CAAO/B,KAAP;AACA6B,uBAAG7B,MAAMA,KAAT,IAAkBL,CAAlB;AACD,mBAJD,MAIO;AACLkC,uBAAG7B,MAAMA,KAAT,IAAkBA,KAAlB;AACD;AACDU,sBAAIkB,SAAJ,GAAgBC,EAAhB;AACD;;;;;;;;;;;;;;;;;;;;;kBA3EgB1C,e","file":"EventNormalizer.js","sourcesContent":["import * as yup from 'yup';\nimport _ from 'lodash';\n\nconst schema = yup.object().shape({\n  web3: yup.object().required(\"Event normalizer requires a web3 instance\"),\n});\n\nexport default class EventNormalizer {\n  constructor(props) {\n    this.web3 = props.web3;\n    let abi = props.abi;\n    this.fnSigs = {};\n\n\n    if(!Array.isArray(abi)) {\n      throw new Error(\"Event normalizer requires abi array of event/function definitions\");\n    }\n\n    abi.forEach(a=>{\n      if(a.type === 'function') {\n        if(a.signature) {\n          this.fnSigs[a.signature] = a;\n        }\n      }\n    });\n\n    [\n      'normalize'\n    ].forEach(fn=>this[fn]=this[fn].bind(this));\n  }\n\n  async normalize(event, history) {\n    let retVals = event.returnValues;\n    //convert big numbers to strings to simplify working with event fields\n    _.keys(retVals).forEach(k=>{\n      let d = retVals[k];\n      if(d._ethersType === 'BigNumber') {\n        retVals[k] = d.toString();\n      }\n    });\n\n    let txn = history[event.transactionHash.toLowerCase()];\n\n    if(!txn) {\n      let start = Date.now();\n      txn = await this.web3.eth.getTransaction(event.transactionHash);\n      console.log(\"Retrieved txn in \", (Date.now()-start),\"ms\");\n      if(txn) {\n        history[txn.hash.toLowerCase()] = txn;\n\n        if(txn.input && txn.input.length > 2) {\n\n          //get the fn signature (4-bytes plus 0x)\n          let sig = txn.input.substring(0, 10);\n\n          //lookup the fn definition by this sig\n          let def = this.fnSigs[sig];\n          if(def) {\n            //if we found a matching fn, tag the transaction with the\n            //fn's name. This will be used downstream as a context for\n            //all attached log events\n            txn.fnContext = def.name;\n          }\n        } else {\n          txn.fnContext = \"no_input\";\n        }\n        txn.logEvents = {};\n      }\n    }\n    if(txn) {\n      let le = {\n        ...txn.logEvents\n      };\n      let ex = le[event.event];\n      if(ex) {\n        let a = [ex];\n        a.push(event);\n        le[event.event] = a;\n      } else {\n        le[event.event] = event;\n      }\n      txn.logEvents = le;\n    }\n  }\n}\n"]}