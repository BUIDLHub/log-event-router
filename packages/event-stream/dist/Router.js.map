{"version":3,"sources":["../src/Router.js"],"names":["Router","props","globalHandlers","contextHandlers","errorHandler","forEach","fn","bind","args","length","context","shift","ex","push","a","ctx","block","txns","transactions","i","t","enrichedCtx","sub","SubContext","baseContext","txn","handlers","next","tgt","fnContext","index","Promise","done","err","nxt","h","process"],"mappings":"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","file":"Router.js","sourcesContent":["\nexport default class Router {\n  constructor(props) {\n    this.globalHandlers = [];\n    this.contextHandlers = {};\n    this.errorHandler = props.errorHandler;\n\n    [\n      'use',\n      'process'\n    ].forEach(fn=>this[fn]=this[fn].bind(this));\n  }\n\n  use(...args) {\n    if(args.length === 0) {\n      return this;\n    }\n    let context = args.shift();\n    if(typeof context === 'string') {\n      let ex = this.contextHandlers[context] || [];\n      args.forEach(a=>ex.push(a));\n      this.contextHandlers[context] = ex;\n    } else {\n      this.globalHandlers.push(context);\n    }\n    return this;\n  }\n\n  async process(ctx, block) {\n    let txns = block.transactions;\n    for(let i=0;i<txns.length;++i) {\n      let t = txns[i];\n      let enrichedCtx = {\n        ...ctx\n      };\n      try {\n        let sub = new SubContext({\n          baseContext: enrichedCtx,\n          txn: t,\n          handlers: this.globalHandlers\n        });\n        enrichedCtx = sub.ctx;\n        await sub.next();\n        let tgt = this.contextHandlers[t.fnContext];\n        if(tgt) {\n          let sub = new SubContext({\n            baseContext: enrichedCtx,\n            txn: t,\n            handlers: tgt\n          });\n          await sub.next();\n        }\n      } catch (e) {\n        if(this.errorHandler) {\n          this.errorHandler(e);\n        }\n      }\n    }\n  }\n}\n\nclass SubContext {\n  constructor(props) {\n    this.ctx = {\n      ...props.baseContext,\n      txn: props.txn\n    };\n    this.handlers = props.handlers;\n    this.index = 0;\n    [\n      'next'\n    ].forEach(fn=>this[fn]=this[fn].bind(this));\n  }\n\n  next() {\n    return new Promise(async (done,err)=>{\n      let nxt = async () => {\n        let h = this.handlers[this.index];\n        ++this.index;\n        if(h) {\n          try {\n            if(typeof h === 'function') {\n              await h(this.ctx, nxt);\n            } else if(typeof h.process === 'function'){\n              await h.process(this.ctx, nxt);\n            }\n          } catch (e) {\n            err(e);\n          }\n        } else {\n          done();\n        }\n      }\n      let h = this.handlers[0];\n      ++this.index;\n      if(h) {\n        try {\n          if(typeof h === 'function') {\n            await h(this.ctx, nxt);\n          } else if(typeof h.process === 'function') {\n            await h.process(this.ctx, nxt);\n          }\n        } catch (e) {\n          err(e);\n        }\n      } else {\n        done();\n      }\n    });\n\n  }\n}\n"]}