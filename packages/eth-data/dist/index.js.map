{"version":3,"sources":["../src/index.js"],"names":["log","Log","component","EthBlock","props","number","undefined","timestamp","_byHash","forEach","fn","bind","evt","hash","transactionHash","Error","toLowerCase","bundle","debug","EventBundle","transactionIndex","blockNumber","addEvent","_","values","allEvents","logEvents","push","sort","a","b","logIndex","event"],"mappings":";;;;;;;;;;AAAA;;;;AACA;;;;;;;;AAEA,IAAMA,MAAM,IAAIC,sBAAJ,CAAQ,EAACC,WAAW,UAAZ,EAAR,CAAZ;;IAEqBC,Q;AACnB,oBAAYC,KAAZ,EAAmB;AAAA;;AAAA;;AACjB,SAAKC,MAAL,GAAcD,QAAMA,MAAMC,MAAZ,GAAmBC,SAAjC;AACA,SAAKC,SAAL,GAAiBH,QAAMA,MAAMG,SAAZ,GAAsBD,SAAvC;;AAEA,SAAKE,OAAL,GAAe,EAAf;AACA,KACE,UADF,EAEEC,OAFF,CAEU;AAAA,aAAI,MAAKC,EAAL,IAAS,MAAKA,EAAL,EAASC,IAAT,CAAc,KAAd,CAAb;AAAA,KAFV;AAGD;;;;6BAYQC,G,EAAK;AACZ,UAAIC,OAAOD,IAAIE,eAAf;AACA,UAAG,CAACD,IAAJ,EAAU;AACR,cAAM,IAAIE,KAAJ,CAAU,kCAAV,CAAN;AACD;AACDF,aAAOA,KAAKG,WAAL,EAAP;AACA,UAAIC,SAAS,KAAKT,OAAL,CAAaK,IAAb,CAAb;AACA,UAAG,CAACI,MAAJ,EAAY;AACVjB,YAAIkB,KAAJ,CAAU,gCAAV,EAA4CL,IAA5C;AACAI,iBAAS,IAAIE,WAAJ,CAAgB;AACvBL,2BAAiBD,IADM;AAEvBO,4BAAkBR,IAAIQ,gBAFC;AAGvBC,uBAAa,KAAKhB,MAHK;AAIvBE,qBAAW,KAAKA;AAJO,SAAhB,CAAT;AAMA,aAAKC,OAAL,CAAaK,IAAb,IAAqBI,MAArB;AACD;AACDA,aAAOK,QAAP,CAAgBV,GAAhB;AACD;;;wBA5BkB;AACjB,aAAOW,iBAAEC,MAAF,CAAS,KAAKhB,OAAd,CAAP;AACD;;;wBAEY;AACX,0BACK,KAAKA,OADV;AAGD;;;;;;kBAnBkBL,Q;;IA0CfgB,W;AACJ,uBAAYf,KAAZ,EAAmB;AAAA;;AAAA;;AACjB,SAAKU,eAAL,GAAuBV,MAAMU,eAA7B;AACA,SAAKM,gBAAL,GAAwBhB,MAAMgB,gBAA9B;AACA,SAAKC,WAAL,GAAmBjB,MAAMiB,WAAzB;AACA,SAAKd,SAAL,GAAiBH,MAAMG,SAAvB;;AAEA,SAAKkB,SAAL,GAAiB,EAAjB;AACA,SAAKC,SAAL,GAAiB,EAAjB;AACA,KACE,UADF,EAEEjB,OAFF,CAEU;AAAA,aAAI,OAAKC,EAAL,IAAS,OAAKA,EAAL,EAASC,IAAT,CAAc,MAAd,CAAb;AAAA,KAFV;AAGD;;;;6BAEQC,G,EAAK;AACZ,WAAKa,SAAL,CAAeE,IAAf,CAAoBf,GAApB;AACA,WAAKa,SAAL,CAAeG,IAAf,CAAoB,UAACC,CAAD,EAAGC,CAAH;AAAA,eAAOD,EAAEE,QAAF,GAAWD,EAAEC,QAApB;AAAA,OAApB;AACA,UAAIF,IAAI,KAAKH,SAAL,CAAed,IAAIoB,KAAnB,KAA6B,EAArC;AACAH,QAAEF,IAAF,CAAOf,GAAP;AACAiB,QAAED,IAAF,CAAO,UAACC,CAAD,EAAGC,CAAH;AAAA,eAAOD,EAAEE,QAAF,GAAWD,EAAEC,QAApB;AAAA,OAAP;AACA,WAAKL,SAAL,CAAed,IAAIoB,KAAnB,IAA4BH,CAA5B;AACD","file":"index.js","sourcesContent":["import _ from 'lodash';\nimport Log from 'stream-logger';\n\nconst log = new Log({component: \"EthBlock\"});\n\nexport default class EthBlock {\n  constructor(props) {\n    this.number = props?props.number:undefined;\n    this.timestamp = props?props.timestamp:undefined;\n\n    this._byHash = {};\n    [\n      'addEvent'\n    ].forEach(fn=>this[fn]=this[fn].bind(this));\n  }\n\n  get transactions() {\n    return _.values(this._byHash);\n  }\n\n  get byHash() {\n    return {\n      ...this._byHash\n    }\n  }\n\n  addEvent(evt) {\n    let hash = evt.transactionHash;\n    if(!hash) {\n      throw new Error(\"Missing transactionHash in event\");\n    }\n    hash = hash.toLowerCase();\n    let bundle = this._byHash[hash];\n    if(!bundle) {\n      log.debug(\"Creating event bundle for hash\", hash);\n      bundle = new EventBundle({\n        transactionHash: hash,\n        transactionIndex: evt.transactionIndex,\n        blockNumber: this.number,\n        timestamp: this.timestamp\n      });\n      this._byHash[hash] = bundle;\n    }\n    bundle.addEvent(evt);\n  }\n}\n\nclass EventBundle {\n  constructor(props) {\n    this.transactionHash = props.transactionHash;\n    this.transactionIndex = props.transactionIndex;\n    this.blockNumber = props.blockNumber;\n    this.timestamp = props.timestamp;\n\n    this.allEvents = [];\n    this.logEvents = {};\n    [\n      'addEvent'\n    ].forEach(fn=>this[fn]=this[fn].bind(this));\n  }\n\n  addEvent(evt) {\n    this.allEvents.push(evt);\n    this.allEvents.sort((a,b)=>a.logIndex-b.logIndex);\n    let a = this.logEvents[evt.event] || [];\n    a.push(evt);\n    a.sort((a,b)=>a.logIndex-b.logIndex);\n    this.logEvents[evt.event] = a;\n  }\n\n}\n"]}